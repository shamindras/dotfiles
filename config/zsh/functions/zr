#!/bin/zsh

##? zr - reload zsh config. Inside tmux, reloads all zsh panes
##?      across every session/window. Outside tmux, reloads the
##?      current shell.
##?
##? usage:
##?   zr [-q | --quiet]
##?
##? options:
##?   -q, --quiet  suppress output

zr() {
  [[ "$1" == "-h" || "$1" == "--help" ]] && { grep "^##?" "${(%):-%x}" | cut -c 5-; return 0; }

  local quiet=false
  [[ "$1" == "-q" || "$1" == "--quiet" ]] && quiet=true

  if [[ -n "$TMUX" ]]; then
    local current_pane pane cmd count=0
    current_pane=$(tmux display-message -p '#{session_name}:#{window_index}.#{pane_index}')

    # Process substitution (not a pipe) so count stays in the current shell
    while read pane cmd; do
      if [[ $cmd == zsh && $pane != "$current_pane" ]]; then
        tmux send-keys -t "$pane" "exec zsh" Enter
        (( count++ ))
        $quiet || echo "  ðŸ”„ $pane"
      fi
    done < <(tmux list-panes -a -F '#{session_name}:#{window_index}.#{pane_index} #{pane_current_command}')

    $quiet || echo "âœ… Reloaded $count remote pane(s), reloading current..."
    exec zsh
  else
    $quiet || echo "ðŸ”„ Reloading shell..."
    exec zsh
  fi
}

# vim: ft=zsh
